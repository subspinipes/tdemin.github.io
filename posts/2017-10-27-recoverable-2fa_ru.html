<!DOCTYPE html>
<html>
  <head prefix="article: http://ogp.me/ns/article#">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-navbutton-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta property="og:type" content="article">
    <meta property="article:author" content="https://tdemin.github.io">
    <meta property="og:site_name" content="Блог Тимура Демина">
    <meta property="og:title" content="Инструкция по созданию возобновляемого токена двухфакторной аутентификации">
    <meta property="og:description" content="Большая часть систем двухфакторной аутентификации не позволяет делать резервное копирование ключей из-за потенциальных проблем с безопасностью. Тем не менее, сделать это можно, причем безопасно!">
    <meta name="description" content="Большая часть систем двухфакторной аутентификации не позволяет делать резервное копирование ключей из-за потенциальных проблем с безопасностью. Тем не менее, сделать это можно, причем безопасно!">
    <title>Инструкция по созданию возобновляемого токена двухфакторной аутентификации — Блог Тимура Демина</title>
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css">
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">
    <link rel="stylesheet" type="text/css" href="/css/icons.min.css">
    <link rel="canonical" href="/posts/2017-10-27-recoverable-2fa_ru">
    <link rel="alternate" hreflang="en" href="/posts/2017-10-27-recoverable-2fa">
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
    <script type="application/ld+json">
      {
      	"@context": "http://schema.org",
      	"@type": "BlogPosting",
      	"name": "Timur Demin's Blog",
      	"url": "https://tdemin.github.io",
      	"headline": "Инструкция по созданию возобновляемого токена двухфакторной аутентификации",
      	"author": {
      		"@type": "Person",
      		"name": "Тимур Демин"
      	},
      	"description": "Большая часть систем двухфакторной аутентификации не позволяет делать резервное копирование ключей из-за потенциальных проблем с безопасностью. Тем не менее, сделать это можно, причем безопасно!",
      	"datePublished": "2017-10-27 00:00:00 +0000",
      	"publisher": {
      		"@type": "Organization",
      		"name": "Timur Demin's Blog",
      		"logo": {
      			"@type": "ImageObject",
      			"url": "https://tdemin.github.io/img/logo.jpg"
      		}
      	},
      	"mainEntityOfPage": {
      		"@type": "WebPage",
      		"@id": "/posts/2017-10-27-recoverable-2fa_ru"
      	},
      	"mainWebsite": {
      		"@id": "https://tdemin.github.io",
      		"@type": "WebSite",
      		"name": "Timur Demin's Blog",
      		"url": "https://tdemin.github.io"
      	}
      }
    </script>
  </head>
  <body>
    <header>
      <h2>Инструкция по созданию возобновляемого токена двухфакторной аутентификации</h2>
      <p><span class="icon-date"></span> <time id="postDate" datetime="2017-10-27">27.10.2017</time></p>
      <p><span class="icon-author"></span> <span class="postAuthor">Тимур Демин</span></p>
    </header>
    <nav>
      <p id="navLang">
        <a class="navActive">РУС</a>
        <a class="navInactive" href="/posts/2017-10-27-recoverable-2fa">ENG</a>
      </p>
    </nav>
    <article>
      <p>Итак, вы хотите активировать двухфакторную аутентификацию (далее 2FA) для своих
        аккаунтов в различных средах. Это довольно просто, Google постарался на славу,
        разработав приложение <a href="https://support.google.com/accounts/answer/1066447?co=GENIE.Platform%3DAndroid&amp;hl=en">Authenticator</a>. Тем не менее,
        проблемы, которые мы будем решать, относятся не к включению 2FA самой по себе.</p>
      <p>Начнем с того, что <em>резервную копию токена сделать нельзя</em>. Опции перемещения
        ключей на другое устройство нет, единственное, что можно сделать — использовать
        т. н. “резервные коды”, позволяющие войти в аккаунт в случае утери токена.
        Google предлагает записать эти коды куда-нибудь и хранить их в безопасном месте,
        и большая часть сервисов с 2FA следует их примеру. Но, сами понимаете,
        физическое хранение ключей сложно назвать безопасным.</p>
      <p>Проблема под номером два прямо выходит из первой: <em>использовать двухфакторную</em>
        <em>аутентификацию на нескольких устройствах не получится</em> просто так. В
        большинстве систем смена устройства означает, что старое устройство будет
        генерировать нерабочие коды, поскольку приватный ключ сменится.</p>
      <p>Ну и последнее (не по значимости): <em>получить ключи назад нельзя</em>. Во всяком
        случае, после того, как они были сохранены на устройстве. Отредактировать их,
        конечно, тоже нельзя. Да, это сделано во имя безопасности, но какая же это
        головная боль иной раз!</p>
      <p>Некоторые разработчики приложений для 2FA поняли, что сдерживает 2FA от широкого
        применения, и попытались это учесть в своих реализациях токенов. Так,
        <a href="https://authy.com/">Authy</a> позволяет использовать несколько устройств, делает резервные
        копии ключей в облаке, позволяя таким образом легко восстанавливать коды на
        новом устройстве. Все бы хорошо, но облачное хранение ключей 2FA потенциально
        понижает безопасность аккаунтов — ключи-то хранятся у других людей. А серверы
        этих других людей вполне могут взломать.</p>
      <p>Собственно, все вышеописанное учтено в моей схеме.</p>
      <hr />
      <p>Итак, с введением покончено, приступим сразу к практике. Требуется следующее:</p>
      <ul>
        <li>несколько устройств-генераторов кодов;</li>
        <li>резервные копии ключей;</li>
        <li>легкое восстановление кодов на новых устройствах;</li>
        <li>добавление ключей на устройство сканированием QR-кода.</li>
      </ul>
      <p>Все это необходимо выполнить, не нарушая безопасность аккаунтов.</p>
      <p>Единственный приемлемый путь к этому состоит в хранении приватных ключей в
        безопасном месте. На ПК это может быть шифрованный контейнер, в котором будут
        храниться наши ключи. Я не буду описывать процесс создания контейнера здесь, это
        займет слишком много места, лишь направлю на сайт <a href="https://www.veracrypt.fr/en/Home.html">VeraCrypt</a>,
        прекрасной программы для работы с шифрованными контейнерами. Пожалуй,
        единственное, что стоит учесть: большой контейнер для хранения ключей в
        текстовом файле не требуется, достаточно и пары мегабайт.</p>
      <p>После создания контейнера и сохранения в нем пока пустого текстового файла мы
        включаем двухфакторную аутентификацию на сайтах, правда, сделаем мы это немного
        иначе, не так, как ждет от нас система. Не сканируем код, выбираем “Я не могу
        просканировать код” (или как там это называется в вашей системе) и копируем
        полученный приватный ключ в наш текстовый файл. Сделаем это надо всеми
        аккаунтами, при этом не подтверждая сохранение ключа и не вводя кода на сайтах
        (просто останьтесь на странице с формой, не переходя никуда).</p>
      <p>Теперь немного поколдуем над полученными ключами. QR-коды для сканирования в
        приложениях, конечно, получаются не с помощью особой, уличной магии, их
        содержимое — тот же ключ, просто представленный в специфичном виде так, чтобы
        устройство сразу распознало имя аккаунта и опции для него. Сформируем коды тем
        же <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format" title="Google Authenticator Key URI format">алгоритмом</a>, что и Google Authenticator:</p>
      <p><code class="highlighter-rouge">otpauth://totp/Сайт:НазваниеАккаунта?secret=ПРИВАТНЫЙКЛЮЧ</code></p>
      <p>После этого удостоверимся, что в строке нет пробелов, если они есть, убираем.
        Название аккаунта к вставке не обязательно. Сделаем это для всех ключей.</p>
      <p>Так, теперь у нас есть коды, осталось только получить их QR-вариант и
        отсканировать. Ставим любое приложение для генерации QR-кодов (я воспользовался
        <a href="https://code.google.com/archive/p/qrencode-win32/" title="qrencode, a very simple program">этим</a>) и загоняем в него строки, полученные на предыдущем этапе, по
        одной. То, что получилось, сканируем в Google Authenticator.</p>
      <p>Готово! У нас теперь есть резервная копия приватных ключей, хранящаяся безопасно
        (во всяком случае, настолько, насколько безопасен наш компьютер для хранения
        данных и безопасен AES). Мы также можем загнать их в другое приложение или
        устройство при желании. Ну и, разумеется, их можно добавить в токен, не вбивая
        ключ вручную (опечатки исключены). Все это без компрометации аккаунтов.</p>
      <p>Как обычно, прокомментировать сей пост или предложить поправки можно,
        <a href="mailto:demintimur@gmail.com">послав мне письмо</a> по электронной почте.</p>
    </article>
    <footer>
      <hr />
      <p id="licenseNotice">
        © Тимур Демин, 2017<br>
        За исключением случаев, где явно выражено иное, содержимое этого сайта распространяется на условиях лицензии Creative Commons Attribution 4.0 International License.
        <a href="/licenses_ru">Подробнее</a>.
      </p>
    </footer>
  </body>
</html>